<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GMHKEWCJ20"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GMHKEWCJ20');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moderna Home - Modern Furniture Store</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate 50 */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0; /* Slate 200 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8; /* Slate 400 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* Slate 500 */
        }
    </style>

    <!-- Google Analytics 4 (gtag.js) -->
    <!-- REPLACE 'G-XXXXXXXXXX' with your actual GA4 Measurement ID -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      // Initialize GA4 config with your Measurement ID
      gtag('config', 'G-XXXXXXXXXX', {
        'send_page_view': true, // Ensures page_view events are sent
      });

      console.log('GA4 Initialized. Remember to replace G-XXXXXXXXXX with your actual Measurement ID.');
    </script>
</head>
<body class="text-gray-800">

    <nav class="bg-white shadow-sm py-4 px-6 fixed w-full z-10">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#" onclick="showPage('home')" class="text-2xl font-bold text-gray-900 rounded-lg p-2 hover:bg-gray-100 transition-colors">Moderna Home</a>
            <div class="flex items-center space-x-6">
                <a href="#" onclick="showPage('home')" class="text-gray-700 hover:text-gray-900 font-medium transition-colors rounded-lg px-3 py-2 hover:bg-gray-100">Home</a>
                <a href="#" onclick="showPage('products')" class="text-gray-700 hover:text-gray-900 font-medium transition-colors rounded-lg px-3 py-2 hover:bg-gray-100">Products</a>
                <button onclick="showPage('cart')" class="relative text-gray-700 hover:text-gray-900 font-medium transition-colors rounded-lg px-3 py-2 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <svg class="w-6 h-6 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 4a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    Cart (<span id="cart-count">0</span>)
                </button>
            </div>
        </div>
    </nav>

    <main class="pt-20">
        <!-- Homepage Section -->
        <section id="home-page" class="page-section active bg-gradient-to-br from-blue-50 to-indigo-100 py-16 px-4">
            <div class="container mx-auto text-center py-20 rounded-xl shadow-lg bg-white bg-opacity-80 backdrop-blur-sm">
                <h1 class="text-5xl font-extrabold text-gray-900 mb-6 leading-tight">Your Home, Reimagined.</h1>
                <p class="text-xl text-gray-700 mb-10 max-w-2xl mx-auto">Discover modern and elegant furniture that transforms your living spaces into a haven of comfort and style.</p>
                <img src="https://media.architecturaldigest.com/photos/6553d8773947b7f6f77b02c5/16:9/w_1920%2Cc_limit/Living%2520room_%2520Devon%2520Grace%2520Interiors_credit_%2520Dustin%2520Halleck_1.jpg" alt="Modern living room setup" class="w-full max-w-4xl mx-auto rounded-xl shadow-lg mb-10">
                <button onclick="showPage('products'); if (typeof gtag === 'function') { gtag('event', 'hero_cta_click', { button_text: 'Shop All Collections' }); }" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                    Shop All Collections
                </button>
            </div>
        </section>

        <!-- Product Listing Page Section -->
        <section id="products-page" class="page-section hidden py-16 px-4">
            <div class="container mx-auto">
                <h2 class="text-4xl font-bold text-gray-900 mb-10 text-center">Our Furniture Collection</h2>

                <div class="flex flex-col md:flex-row justify-between items-center mb-8 space-y-4 md:space-y-0">
                    <div class="flex items-center space-x-3">
                        <label for="sort-by" class="text-gray-700 font-medium">Sort By:</label>
                        <select id="sort-by" onchange="sortProducts(this.value); if (typeof gtag === 'function') { gtag('event', 'sort_applied', { sort_by: this.value }); }" class="border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="price-asc">Price (Low to High)</option>
                            <option value="price-desc">Price (High to Low)</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-3">
                        <label for="filter-category" class="text-gray-700 font-medium">Filter By Category:</label>
                        <select id="filter-category" onchange="filterProducts(this.value); if (typeof gtag === 'function') { gtag('event', 'filter_applied', { filter_type: 'category', filter_value: this.value }); }" class="border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <option value="all">All Categories</option>
                            <option value="Sofas">Sofas</option>
                            <option value="Chairs">Chairs</option>
                            <option value="Tables">Tables</option>
                            <option value="Beds">Beds</option>
                        </select>
                    </div>
                </div>

                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                    <!-- Products will be dynamically loaded here -->
                </div>
            </div>
        </section>

        <!-- Product Detail Page Section -->
        <section id="product-detail-page" class="page-section hidden py-16 px-4 bg-gray-50">
            <div class="container mx-auto bg-white rounded-xl shadow-lg p-8">
                <button onclick="showPage('products')" class="text-blue-600 hover:text-blue-800 font-medium mb-6 flex items-center transition-colors">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Back to Products
                </button>
                <div id="product-detail-content" class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <!-- Product details will be dynamically loaded here -->
                </div>
            </div>
        </section>

        <!-- Cart Page Section -->
        <section id="cart-page" class="page-section hidden py-16 px-4">
            <div class="container mx-auto">
                <h2 class="text-4xl font-bold text-gray-900 mb-10 text-center">Your Shopping Cart</h2>
                <div id="cart-items" class="bg-white rounded-xl shadow-lg p-8 mb-8">
                    <!-- Cart items will be dynamically loaded here -->
                    <p id="empty-cart-message" class="text-center text-gray-500 text-lg">Your cart is empty.</p>
                </div>
                <div id="cart-summary" class="bg-white rounded-xl shadow-lg p-8 flex flex-col md:flex-row justify-between items-center">
                    <p class="text-2xl font-bold text-gray-900 mb-4 md:mb-0">Total: <span id="cart-total">$0.00</span></p>
                    <button onclick="showPage('checkout'); trackBeginCheckout();" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300 disabled:opacity-50" id="proceed-to-checkout-btn" disabled>
                        Proceed to Checkout
                    </button>
                </div>
            </div>
        </section>

        <!-- Checkout Page Section -->
        <section id="checkout-page" class="page-section hidden py-16 px-4 bg-blue-50">
            <div class="container mx-auto bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-4xl font-bold text-gray-900 mb-10 text-center">Checkout</h2>
                <form id="checkout-form" class="max-w-2xl mx-auto space-y-6">
                    <div>
                        <h3 class="text-2xl font-semibold text-gray-800 mb-4">Shipping Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="fullName" class="block text-gray-700 text-sm font-bold mb-2">Full Name</label>
                                <input type="text" id="fullName" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="John Doe" required>
                            </div>
                            <div>
                                <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                                <input type="email" id="email" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="john.doe@example.com" required>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="address" class="block text-gray-700 text-sm font-bold mb-2">Address</label>
                            <input type="text" id="address" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="123 Main St" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div>
                                <label for="city" class="block text-gray-700 text-sm font-bold mb-2">City</label>
                                <input type="text" id="city" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="Anytown" required>
                            </div>
                            <div>
                                <label for="state" class="block text-gray-700 text-sm font-bold mb-2">State</label>
                                <input type="text" id="state" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="CA" required>
                            </div>
                            <div>
                                <label for="zip" class="block text-gray-700 text-sm font-bold mb-2">Zip Code</label>
                                <input type="text" id="zip" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="12345" required>
                            </div>
                        </div>
                    </div>

                    <hr class="border-gray-200">

                    <div>
                        <h3 class="text-2xl font-semibold text-gray-800 mb-4">Payment Information</h3>
                        <div>
                            <label for="cardNumber" class="block text-gray-700 text-sm font-bold mb-2">Card Number</label>
                            <input type="text" id="cardNumber" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="**** **** **** ****" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div>
                                <label for="expMonth" class="block text-gray-700 text-sm font-bold mb-2">Exp. Month</label>
                                <input type="text" id="expMonth" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="MM" required>
                            </div>
                            <div>
                                <label for="expYear" class="block text-gray-700 text-sm font-bold mb-2">Exp. Year</label>
                                <input type="text" id="expYear" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="YY" required>
                            </div>
                            <div>
                                <label for="cvv" class="block text-gray-700 text-sm font-bold mb-2">CVV</label>
                                <input type="text" id="cvv" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="123" required>
                            </div>
                        </div>
                    </div>

                    <div id="checkout-summary" class="bg-gray-50 rounded-lg p-6 shadow-inner">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-4">Order Summary</h3>
                        <div id="checkout-summary-items" class="space-y-2 mb-4">
                            <!-- Items will be loaded here -->
                        </div>
                        <div class="flex justify-between items-center text-lg font-medium text-gray-700 border-t border-gray-200 pt-3">
                            <span>Subtotal:</span>
                            <span id="checkout-subtotal">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-lg font-medium text-gray-700">
                            <span>Shipping:</span>
                            <span id="checkout-shipping">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-lg font-medium text-gray-700">
                            <span>Tax:</span>
                            <span id="checkout-tax">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-2xl font-bold text-gray-900 border-t border-gray-300 pt-4 mt-4">
                            <span>Grand Total:</span>
                            <span id="checkout-grand-total">$0.00</span>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-full shadow-lg transform transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                        Place Order
                    </button>
                </form>
            </div>
        </section>

        <!-- Confirmation / Message Box -->
        <div id="message-box" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-20">
            <div class="bg-white rounded-xl shadow-lg p-8 max-w-sm w-full text-center">
                <h3 id="message-title" class="text-2xl font-bold mb-4"></h3>
                <p id="message-content" class="text-gray-700 mb-6"></p>
                <button onclick="hideMessageBox()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full transition-colors">
                    OK
                </button>
            </div>
        </div>
    </main>

    <script>
        // --- Product Data (Mock Data) ---
        const products = [
            { id: 'SF001', name: 'Elegant Velvet Sofa', category: 'Sofas', price: 999.99, imageUrl: 'https://www.therange.co.uk/media/0/1/1684579445_12_9646.jpg', description: 'Luxurious velvet sofa designed for ultimate comfort and style. Perfect for modern living rooms.' },
            { id: 'CH002', name: 'Mid-Century Armchair', category: 'Chairs', price: 249.00, imageUrl: 'https://www.estre.in/cdn/shop/files/1-min_1a7b23d8-e00c-4bca-86fe-9c65a55bcd1d.jpg?v=1743763633', description: 'Classic mid-century design armchair with solid wood frame and comfortable upholstery.' },
            { id: 'DT003', name: 'Minimalist Dining Table', category: 'Tables', price: 599.50, imageUrl: 'https://www.rajwadafurnish.com/cdn/shop/files/Oasis-Solid-Wood-4-Seater-Dining-Table-Sets-honey-rajawada-furnish.webp?v=1737974650', description: 'Sleek and sturdy dining table, perfect for small to medium-sized dining areas.' },
            { id: 'BD004', name: 'Plush Queen Bed', category: 'Beds', price: 850.00, imageUrl: 'https://ebansal.com/cdn/shop/files/Olivia_Solid_Sheesham_Wood_Bed_With_Four_Drawers_Queen_Size_Natural_Finish_1200x.jpg?v=1745910757', description: 'Soft and comfortable queen-sized bed with a padded headboard for restful nights.' },
            { id: 'SF005', name: 'Sectional Cloud Sofa', category: 'Sofas', price: 1500.00, imageUrl: 'https://www.peelorange.com/cdn/shop/files/londosa-236880_600x_8b12d7fa-e80b-4dd0-91e4-2d158d1b9c87_1024x.webp?v=1726133925', description: 'Expansive sectional sofa, perfect for large families and entertaining guests. Ultra soft cushions.' },
            { id: 'CH006', name: 'Ergonomic Office Chair', category: 'Chairs', price: 180.00, imageUrl: 'https://shop.gkwretail.com/cdn/shop/products/OfficeChairUpholstered5CasterWheelsOfficeChair.jpg?v=1640772341', description: 'Designed for long hours of work, providing excellent back support and adjustability.' },
            { id: 'ST007', name: 'Round Coffee Table', category: 'Tables', price: 120.00, imageUrl: 'https://images-cdn.ubuy.co.in/6681d8ed9f556206a8765293-justone-31-49-round-coffee-table.jpg', description: 'Stylish round coffee table with metal legs and a smooth wooden top.' },
            { id: 'BD008', name: 'King Platform Bed', category: 'Beds', price: 1100.00, imageUrl: 'https://www.royaloakindia.com/media/catalog/product/b/s/bs-120b_8s_9l_11_copy_1.jpg?optimize=high&bg-color=255,255,255&fit=bounds&height=300&width=480&canvas=480:300', description: 'Contemporary king-sized platform bed, no box spring required, sturdy and elegant.' },
        ];

        // Initialize cart from localStorage or as empty array
        let currentCart = JSON.parse(localStorage.getItem('cart')) || [];
        let currentProduct = null; // Stores the currently viewed product for PDP

        // --- DOM Elements ---
        const pages = document.querySelectorAll('.page-section');
        const productListingsDiv = document.getElementById('product-list');
        const productDetailContentDiv = document.getElementById('product-detail-content');
        const cartCountSpan = document.getElementById('cart-count');
        const cartItemsDiv = document.getElementById('cart-items');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const cartTotalSpan = document.getElementById('cart-total');
        const proceedToCheckoutBtn = document.getElementById('proceed-to-checkout-btn');
        const checkoutForm = document.getElementById('checkout-form');
        const checkoutSummaryItemsDiv = document.getElementById('checkout-summary-items');
        const checkoutSubtotalSpan = document.getElementById('checkout-subtotal');
        const checkoutShippingSpan = document.getElementById('checkout-shipping');
        const checkoutTaxSpan = document.getElementById('checkout-tax');
        const checkoutGrandTotalSpan = document.getElementById('checkout-grand-total');
        const messageBox = document.getElementById('message-box');
        const messageTitle = document.getElementById('message-title');
        const messageContent = document.getElementById('message-content');


        // --- Page Navigation ---
        function showPage(pageId) {
            pages.forEach(page => page.classList.add('hidden'));
            document.getElementById(`${pageId}-page`).classList.remove('hidden');

            // Update URL hash for simple navigation and better GA4 page_view tracking
            window.location.hash = pageId;

            let pageTitle = '';
            let pageLocation = window.location.href; // Default to current URL
            let pagePath = `/${pageId}`; // A cleaner path for GA4

            switch(pageId) {
                case 'home':
                    pageTitle = 'Homepage - Moderna Home';
                    break;
                case 'products':
                    pageTitle = 'Products - Moderna Home';
                    loadProducts(); // Ensure products are loaded when navigating to this page
                    break;
                case 'product-detail':
                    // `currentProduct` should be set by `showProductDetail` before `showPage` is called for PDP
                    pageTitle = `${currentProduct ? currentProduct.name : 'Product Details'} - Moderna Home`;
                    // Create a more specific virtual URL for PDP
                    pageLocation = `${window.location.origin}${window.location.pathname}#product-detail?id=${currentProduct ? currentProduct.id : ''}`;
                    pagePath = `/product-detail/${currentProduct ? currentProduct.id : ''}`;
                    break;
                case 'cart':
                    pageTitle = 'Shopping Cart - Moderna Home';
                    updateCartDisplay(); // Refresh cart display
                    break;
                case 'checkout':
                    pageTitle = 'Checkout - Moderna Home';
                    updateCheckoutSummary(); // Refresh checkout summary
                    break;
            }
            // Trigger a page_view event for GA4
            if (typeof gtag === 'function') { // Check if gtag is defined
                gtag('event', 'page_view', {
                    page_title: pageTitle,
                    page_location: pageLocation,
                    page_path: pagePath,
                });
                console.log(`GA4: page_view event sent for ${pageId} (Title: ${pageTitle}, Path: ${pagePath})`);
            } else {
                console.warn('gtag is not defined. Google Analytics may not be loaded.');
            }

            window.scrollTo(0, 0); // Scroll to top on page change
        }

        // --- Product Listing Logic ---
        function renderProducts(productsToRender) {
            productListingsDiv.innerHTML = ''; // Clear previous products
            if (productsToRender.length === 0) {
                productListingsDiv.innerHTML = '<p class="col-span-full text-center text-gray-500 text-lg">No products found matching your criteria.</p>';
                return;
            }

            const fragment = document.createDocumentFragment(); // Use DocumentFragment for performance

            productsToRender.forEach(product => {
                const productCardDiv = document.createElement('div');
                productCardDiv.className = "bg-white rounded-xl shadow-md overflow-hidden transform transition-transform duration-300 hover:scale-105 hover:shadow-xl cursor-pointer";
                // Use an arrow function for the onclick handler to directly pass product.id
                productCardDiv.onclick = () => showProductDetail(product.id);
                productCardDiv.innerHTML = `
                    <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-48 object-cover">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">${product.name}</h3>
                        <p class="text-gray-600 text-sm mb-3">${product.category}</p>
                        <p class="text-2xl font-bold text-blue-600">$${product.price.toFixed(2)}</p>
                    </div>
                `;
                fragment.appendChild(productCardDiv);
            });
            productListingsDiv.appendChild(fragment); // Append fragment to the DOM once
        }

        function loadProducts() {
            renderProducts(products); // Initially render all products
        }

        function sortProducts(criteria) {
            let sortedProducts = [...products]; // Create a copy to sort
            switch (criteria) {
                case 'name-asc':
                    sortedProducts.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'name-desc':
                    sortedProducts.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'price-asc':
                    sortedProducts.sort((a, b) => a.price - b.price);
                    break;
                case 'price-desc':
                    sortedProducts.sort((a, b) => b.price - a.price);
                    break;
            }
            renderProducts(sortedProducts);
        }

        function filterProducts(category) {
            let filteredProducts = products;
            if (category !== 'all') {
                filteredProducts = products.filter(p => p.category === category);
            }
            renderProducts(filteredProducts);
        }

        // --- Product Detail Logic ---
        function showProductDetail(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                console.error('Product not found:', productId);
                showMessageBox('Error', 'Product not found.');
                return;
            }
            currentProduct = product; // Store current product for add to cart
            productDetailContentDiv.innerHTML = `
                <div class="md:col-span-1">
                    <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-auto rounded-lg shadow-md">
                </div>
                <div class="md:col-span-1">
                    <h2 class="text-4xl font-bold text-gray-900 mb-3">${product.name}</h2>
                    <p class="text-blue-600 text-lg font-semibold mb-2">${product.category}</p>
                    <p class="text-5xl font-extrabold text-blue-600 mb-6">$${product.price.toFixed(2)}</p>
                    <p class="text-gray-700 leading-relaxed mb-6">${product.description}</p>
                    <div class="flex items-center space-x-4 mb-8">
                        <label for="quantity" class="text-lg font-medium text-gray-700">Quantity:</label>
                        <input type="number" id="product-quantity" value="1" min="1" class="w-20 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-center">
                    </div>
                    <button onclick="addToCart(currentProduct)" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                        Add to Cart
                    </button>
                </div>
            `;
            showPage('product-detail');

            // GA4: view_item event
            if (typeof gtag === 'function') {
                gtag('event', 'view_item', {
                    currency: 'USD',
                    value: product.price,
                    items: [{
                        item_id: product.id,
                        item_name: product.name,
                        item_category: product.category,
                        price: product.price,
                        quantity: 1 // Default quantity when viewing
                    }]
                });
                console.log('GA4: view_item event sent for', product.name);
            }
        }

        // --- Cart Logic ---
        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(currentCart));
        }

        function addToCart(product) {
            const quantityInput = document.getElementById('product-quantity');
            const quantity = quantityInput ? parseInt(quantityInput.value) : 1;

            if (quantity <= 0 || isNaN(quantity)) {
                showMessageBox('Invalid Quantity', 'Please enter a valid quantity.');
                return;
            }

            const existingItemIndex = currentCart.findIndex(item => item.id === product.id);

            if (existingItemIndex > -1) {
                currentCart[existingItemIndex].quantity += quantity;
            } else {
                currentCart.push({ ...product, quantity: quantity });
            }
            saveCart(); // Persist cart to local storage
            updateCartCount();
            showMessageBox('Added to Cart!', `${product.name} (x${quantity}) has been added to your cart.`);

            // GA4: add_to_cart event
            if (typeof gtag === 'function') {
                gtag('event', 'add_to_cart', {
                    currency: 'USD',
                    value: product.price * quantity,
                    items: [{
                        item_id: product.id,
                        item_name: product.name,
                        item_category: product.category,
                        price: product.price,
                        quantity: quantity
                    }]
                });
                console.log('GA4: add_to_cart event sent for', product.name);
            }
        }

        function updateCartCount() {
            const totalItems = currentCart.reduce((sum, item) => sum + item.quantity, 0);
            cartCountSpan.textContent = totalItems;
        }

        function updateCartItemQuantity(productId, newQuantityStr) {
            const newQuantity = parseInt(newQuantityStr);
            if (isNaN(newQuantity) || newQuantity < 0) {
                showMessageBox('Invalid Quantity', 'Quantity must be a positive number.');
                // Revert input to previous valid quantity if invalid input
                updateCartDisplay(); // This will re-render with the correct quantity from currentCart
                return;
            }

            const itemIndex = currentCart.findIndex(item => item.id === productId);

            if (itemIndex > -1) {
                const oldQuantity = currentCart[itemIndex].quantity;
                currentCart[itemIndex].quantity = newQuantity;

                if (newQuantity === 0) {
                    removeFromCart(productId); // Remove if quantity becomes 0
                } else {
                    saveCart();
                    updateCartDisplay();
                    updateCartCount();

                    // GA4: Event for quantity change
                    if (typeof gtag === 'function') {
                        if (newQuantity > oldQuantity) {
                            gtag('event', 'add_to_cart', {
                                currency: 'USD',
                                value: currentCart[itemIndex].price * (newQuantity - oldQuantity),
                                items: [{
                                    item_id: currentCart[itemIndex].id,
                                    item_name: currentCart[itemIndex].name,
                                    item_category: currentCart[itemIndex].category,
                                    price: currentCart[itemIndex].price,
                                    quantity: newQuantity - oldQuantity
                                }]
                            });
                            console.log('GA4: add_to_cart (quantity increase) event sent.');
                        } else if (newQuantity < oldQuantity) {
                            gtag('event', 'remove_from_cart', {
                                currency: 'USD',
                                value: currentCart[itemIndex].price * (oldQuantity - newQuantity),
                                items: [{
                                    item_id: currentCart[itemIndex].id,
                                    item_name: currentCart[itemIndex].name,
                                    item_category: currentCart[itemIndex].category,
                                    price: currentCart[itemIndex].price,
                                    quantity: oldQuantity - newQuantity
                                }]
                            });
                            console.log('GA4: remove_from_cart (quantity decrease) event sent.');
                        }
                    }
                }
            }
        }

        function removeFromCart(productId) {
            const removedItem = currentCart.find(item => item.id === productId);
            if (removedItem) {
                currentCart = currentCart.filter(item => item.id !== productId);
                saveCart();
                updateCartDisplay();
                updateCartCount();
                showMessageBox('Item Removed', `${removedItem.name} has been removed from your cart.`);

                // GA4: remove_from_cart event
                if (typeof gtag === 'function') {
                    gtag('event', 'remove_from_cart', {
                        currency: 'USD',
                        value: removedItem.price * removedItem.quantity,
                        items: [{
                            item_id: removedItem.id,
                            item_name: removedItem.name,
                            item_category: removedItem.category,
                            price: removedItem.price,
                            quantity: removedItem.quantity
                        }]
                    });
                    console.log('GA4: remove_from_cart event sent for', removedItem.name);
                }
            }
        }

        function updateCartDisplay() {
            cartItemsDiv.innerHTML = '';
            let total = 0;

            if (currentCart.length === 0) {
                emptyCartMessage.classList.remove('hidden');
                proceedToCheckoutBtn.disabled = true;
            } else {
                emptyCartMessage.classList.add('hidden');
                proceedToCheckoutBtn.disabled = false;
                currentCart.forEach((item, index) => {
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    const cartItemHtml = `
                        <div class="flex items-center justify-between border-b border-gray-200 py-4 last:border-b-0">
                            <div class="flex items-center space-x-4">
                                <img src="${item.imageUrl}" alt="${item.name}" class="w-20 h-20 object-cover rounded-lg shadow-sm">
                                <div>
                                    <h4 class="text-xl font-semibold text-gray-900">${item.name}</h4>
                                    <p class="text-gray-600">${item.category}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-6">
                                <input type="number" value="${item.quantity}" min="0" class="w-16 p-2 border border-gray-300 rounded-lg text-center" onchange="updateCartItemQuantity('${item.id}', this.value)">
                                <p class="text-lg font-bold text-gray-800">$${itemTotal.toFixed(2)}</p>
                                <button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:text-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-300 rounded-full p-1">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                    `;
                    cartItemsDiv.innerHTML += cartItemHtml;
                });
            }
            cartTotalSpan.textContent = `$${total.toFixed(2)}`;
        }

        // --- Checkout Logic ---
        function updateCheckoutSummary() {
            checkoutSummaryItemsDiv.innerHTML = '';
            let subtotal = 0;

            if (currentCart.length === 0) {
                checkoutSummaryItemsDiv.innerHTML = '<p class="text-center text-gray-500">No items in cart.</p>';
                checkoutSubtotalSpan.textContent = '$0.00';
                checkoutShippingSpan.textContent = '$0.00';
                checkoutTaxSpan.textContent = '$0.00';
                checkoutGrandTotalSpan.textContent = '$0.00';
                return;
            }

            currentCart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                checkoutSummaryItemsDiv.innerHTML += `
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700">${item.name} (x${item.quantity})</span>
                        <span class="font-medium">$${itemTotal.toFixed(2)}</span>
                    </div>
                `;
            });

            // Example calculations for shipping and tax
            const shipping = subtotal > 500 ? 0.00 : 25.00; // Free shipping over $500
            const taxRate = 0.08; // 8% sales tax
            const tax = subtotal * taxRate;
            const grandTotal = subtotal + shipping + tax;

            checkoutSubtotalSpan.textContent = `$${subtotal.toFixed(2)}`;
            checkoutShippingSpan.textContent = `$${shipping.toFixed(2)}`;
            checkoutTaxSpan.textContent = `$${tax.toFixed(2)}`;
            checkoutGrandTotalSpan.textContent = `$${grandTotal.toFixed(2)}`;
        }

        function trackBeginCheckout() {
            if (typeof gtag === 'function') {
                gtag('event', 'begin_checkout', {
                    currency: 'USD',
                    value: currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    items: currentCart.map(item => ({
                        item_id: item.id,
                        item_name: item.name,
                        item_category: item.category,
                        price: item.price,
                        quantity: item.quantity
                    }))
                });
                console.log('GA4: begin_checkout event sent.');
            }
        }

        // Handle checkout form submission
        checkoutForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            // Basic client-side validation (HTML's 'required' handles some)
            if (!this.checkValidity()) {
                showMessageBox('Validation Error', 'Please fill in all required fields correctly.');
                return;
            }

            if (currentCart.length === 0) {
                showMessageBox('Cart Empty', 'Your cart is empty. Please add items before checking out.');
                return;
            }

            // Generate a mock transaction ID
            const transactionId = 'MODERNA-' + Date.now();
            const totalValue = parseFloat(checkoutGrandTotalSpan.textContent.replace('$', ''));
            const shippingCost = parseFloat(checkoutShippingSpan.textContent.replace('$', ''));
            const taxAmount = parseFloat(checkoutTaxSpan.textContent.replace('$', ''));


            // GA4: purchase event
            if (typeof gtag === 'function') {
                gtag('event', 'purchase', {
                    transaction_id: transactionId,
                    affiliation: 'Moderna Home Online Store', // Your store's affiliation
                    value: totalValue,
                    currency: 'USD',
                    tax: taxAmount,
                    shipping: shippingCost,
                    items: currentCart.map(item => ({
                        item_id: item.id,
                        item_name: item.name,
                        item_category: item.category,
                        price: item.price,
                        quantity: item.quantity
                    }))
                });
                console.log('GA4: purchase event sent!', { transaction_id: transactionId });
            }


            // Simulate order processing
            showMessageBox('Order Placed!', `Thank you for your purchase! Your order number is: <b>${transactionId}</b>.<br>A confirmation email has been sent to ${document.getElementById('email').value}.`);

            // Clear cart and form after successful order
            currentCart = [];
            saveCart();
            updateCartCount();
            updateCartDisplay();
            checkoutForm.reset(); // Resets all form fields
            // The hideMessageBox function will handle redirecting to home after dismissal
        });


        // --- Confirmation / Message Box ---
        function showMessageBox(title, content) {
            messageTitle.innerHTML = title; // Use innerHTML for potential bold tags
            messageContent.innerHTML = content; // Use innerHTML for potential bold tags
            messageBox.classList.remove('hidden');
        }

        function hideMessageBox() {
            messageBox.classList.add('hidden');
            // If coming from checkout, redirect to home after message box is dismissed
            if (window.location.hash === '#checkout') {
                showPage('home');
            }
        }

        // --- Initial Load ---
        // Check hash on load to navigate to the correct page
        document.addEventListener('DOMContentLoaded', () => {
            updateCartCount(); // Load cart count from local storage on initial page load
            const initialPage = window.location.hash.substring(1) || 'home';
            showPage(initialPage);

            // Listen for hash changes to navigate without full reloads (e.g., browser back/forward)
            window.addEventListener('hashchange', () => {
                const newPageId = window.location.hash.substring(1) || 'home';
                // Only call showPage if the hash actually changed to a different "page"
                // (showPage already handles updating the hash, so this prevents infinite loops)
                if (document.getElementById(`${newPageId}-page`).classList.contains('hidden')) {
                    showPage(newPageId);
                }
            });
        });

    </script>
</body>
</html>
